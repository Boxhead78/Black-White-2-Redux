//Talus Stuff
// Global Constants
global tal_ResourceGatherRadius = 500.0
global tal_DefendRadius = 1024.0
global tal_MinDesireToStartResource = 0.1
global tal_MaxDesireToStopResource = 0.05
global tal_ManaRatePerAdult = 0.5
global tal_MaxBuiltToGodBuild = 0.5
global tal_DamageToFirefight = 0.9
global tal_EmergencyAllowed = 1

// Number of Disciples
global tal_MaleBreeders = 0 //Look in script "tal_Disciples" 
global tal_Prayers = 0 //Look in script "tal_Disciples" 
global tal_Miners = 0 //Look in script "tal_Disciples" 
global tal_NumDiscipleOther = 0 //Look in script "tal_Disciples" 

// Script Definitions
define script talNewTalus(rTown,PlayerID)
define script tal_TalusLoop(GodHandle,rTown,PlayerID)
define script tal_TalusEmergency(GodHandle,rTown,PlayerID)
define script tal_SatisfyWoodDesire(GodHandle,rTown)
define script tal_SatisfyFoodDesire(GodHandle,rTown)
define script tal_SatisfyOreDesire(GodHandle,rTown)
define script tal_BuildNewBuilding(GodHandle,rTown)
define script tal_Firefight(GodHandle,rTown)
define script tal_Disciples(GodHandle,rTown)
define script tal_MoveRandom(GodHandle,rTown)
define script tal_WaterForest(GodHandle,rTown)
define script tal_FightEnemy(GodHandle,rTown,Target,TargetType)
define script tal_EpicSpell(GodHandle,rTown,whichSpell,Target)
define script tal_HealMyPlatoon(godHandle,rTown)



//Talus Scripts
begin script talNewTalus(rTown,PlayerID)
    godHandle = -1
start
    // Instantiates a new AI instance
    // run script ge_GetNewGodHandle(rTown,godHandle)

    run script ge_GetNewGodHandle(rTown,PlayerID)

    godHandle = geReturnVal
    run script geUnlockReturn
    
    if godHandle > -1 // make sure godHandle is valid
        ge_Busy[godHandle] = 0
        ge_EmergencyMode[godHandle] = 0
        run background script tal_TalusLoop(godHandle,rTown,PlayerID)
        run background script tal_TalusEmergency(godHandle,rTown,PlayerID)
    end if
end script talNewTalus


//Every basic non-reactive god actions in this script
begin script tal_TalusLoop(GodHandle,rTown,PlayerID)
    godHandle = GodHandle
    buildingUnderConstruction = 0
    ClosestPosInfluenceRing = 0
    discipleCounter = 9
    waterForestCounter = 0
    resourcesCounter = 0
    townDesire = 0.0
    manaRate = 0
    miracleCounter = 0
    myBuilding = 0
    myPlatoon = 0
    myCatapult = 0
    myCounter = 0
    myRand = 0
    Number = 0
    NumberOfTowns = 0
    PlayerMana = 0
    Rand = 0
    Timer = create timer for 0 seconds
    townCounter = 0
    whichSpell = 0
    FirstSkelArmy = 0
    ThunderStormUsed = 0
start
    ge_MiracleDelay[godHandle] = create timer for 0 seconds
    while 1 == 1 // make sure godHandle is valid
        wait until rGodInstance[godHandle] exists and IntroFinished == 1
        // Do I need to resource? Don't check these too often
        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            ge_Busy[godHandle] = 1
            if resourcesCounter > 7
                resourcesCounter = 0
                Number = number from 1 to 3
                if Number == 1
                    run script tal_SatisfyFoodDesire(godHandle,ge_HomeTown[godHandle])
                elsif Number == 2
                    run script tal_SatisfyWoodDesire(godHandle,ge_HomeTown[godHandle])
                else
                    run script tal_SatisfyOreDesire(godHandle,ge_HomeTown[godHandle])
                end if
            end if
            ge_Busy[godHandle] = 0
        end if

        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            NumberOfTowns = get player ge_Player[godHandle] town total
            // Are there enough of each disciple type? Don't do this too often
            if discipleCounter > 30
                ge_Busy[godHandle] = 1
                discipleCounter = 0
                run script tal_Disciples(godHandle,ge_HomeTown[godHandle])
                ge_Busy[godHandle] = 0
            end if
        end if

        // Are there any new buildings to build?
        // (May go mad if there is not enough resources anywhere, haven't tested.)
        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            ge_Busy[godHandle] = 1
            run script tal_BuildNewBuilding(godHandle,ge_HomeTown[godHandle])
            ge_Busy[godHandle] = 0
        end if
        
        // Are any of my structures on fire?
        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            ge_Busy[godHandle] = 1
            run script tal_Firefight(godHandle,ge_HomeTown[godHandle])
            ge_Busy[godHandle] = 0
        end if

        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            //Heal my Platoons
            if get Timer time remaining <= 0
                ge_Busy[godHandle] = 1
                run script tal_HealMyPlatoon(godHandle,ge_HomeTown[godHandle])
                ge_Busy[godHandle] = 0
                Timer = create timer for 300 seconds
            end if
        end if

        //Water Forests
        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            if waterForestCounter > 12
                ge_Busy[godHandle] = 1
                waterForestCounter = 0
                run script tal_WaterForest(godHandle,ge_HomeTown[godHandle])
                ge_Busy[godHandle] = 0
            end if
        end if

        // Prevent from idling
        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            ge_Busy[godHandle] = 1
            run script tal_MoveRandom(godHandle,ge_HomeTown[godHandle])
            ge_Busy[godHandle] = 0
        end if

        if ge_Busy[godHandle] == 0 and SacrificeAllowed == 1 and GB_DialogueIsRunning == 0 and get player ge_Player[godHandle] mana > 20000 and ge_EmergencyMode[godHandle] == 0 and ge_Altar[godHandle] == 1
            ge_Busy[godHandle] = 1
            SacrificeAllowed = 0
            GB_DialogueIsRunning = 1
            begin dialogue
                myRand = number from 1 to 4
                if myRand == 1
                    say "BW2XT_LAND03_TALUS_SACRIFICE_20"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_SACRIFICE_20 + 1 seconds
                elsif myRand == 2
                    say "BW2XT_LAND03_TALUS_SACRIFICESVILLAGER"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_SACRIFICESVILLAGER + 1 seconds
                elsif myRand == 3
                    say "BW2XT_LAND03_TALUS_SKELETONS_20"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_SKELETONS_20 + 1 seconds
                elsif myRand == 4
                    say "BW2XT_LAND03_TALUS_SKELETONS_10"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_SKELETONS_10 + 1 seconds
                elsif myRand == 5
                    say "BW2XT_LAND03_TALUS_SKELETONS_30"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_SKELETONS_30 + 1 seconds
                elsif myRand == 6
                    say "BW2XT_LAND03_TALUS_SUMMONS_SKELETONS_10"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_SUMMONS_SKELETONS_10 + 1 seconds
                end if
            end dialogue
            GB_DialogueIsRunning = 0

            run script ge_MoveToRadiusAltitude(godHandle,marker at {977.41,279.34,1748.11},geGodThrowRadius / 2,geGodThrowAltitude)
            run script ge_ThrowMiracle(godHandle, GE_MIRACLE_TYPE_DEATH, marker at {977.41,279.34,1748.11}, 1)

            wait until GB_DialogueIsRunning == 0
            GB_DialogueIsRunning = 1
            begin dialogue
                if FirstSkelArmy == 0
                    FirstSkelArmy = 1
                    wait 5 seconds
                    make evil spirit appear
                    make good spirit appear
                    say "BW2XT_LAND03_TALUS_ARMY_10"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_ARMY_10 + 1 seconds
                    say "BW2XT_LAND03_TALUS_ARMY_20"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND03_TALUS_ARMY_20 + 1 seconds
                    send evil spirit home
                    send good spirit home
                end if
            end dialogue
            GB_DialogueIsRunning = 0
            wait number from 2 to 4 seconds
            ge_Busy[godHandle] = 0
        end if

        if ge_Busy[godHandle] == 0 and get ThrowMiracleTimer time remaining <= 0 and get player ge_Player[godHandle] mana > 23000 and PLAYER of PlayerTown == 0 and PLAYER of AztecTown1 == 1 and GB_DialogueIsRunning == 0 and ge_EmergencyMode[godHandle] == 0 and ge_Altar[godHandle] == 1
            ge_Busy[godHandle] = 1
            MiracleTimerStarted = 1
            GB_DialogueIsRunning = 1
            begin dialogue
                myRand = number from 1 to 4
                if myRand == 1
                    say "BW2XT_LAND02_TALUS_FIRE_20"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND02_TALUS_FIRE_20 + 1 seconds
                    say "BW2XT_LAND02_TALUS_FIRE_50"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND02_TALUS_FIRE_50 + 1 seconds
                elsif myRand == 2
                    say "BW2XT_LAND05_TALUS_MIRACLE_ATTACK_40"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND05_TALUS_MIRACLE_ATTACK_40 + 1 seconds
                elsif myRand == 3
                    say "BW2XT_LAND02_PLAYER_ACCEPTS_MIGRATION_10"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND02_PLAYER_ACCEPTS_MIGRATION_10 + 1 seconds
                elsif myRand == 4
                    say "BW2XT_LAND02_PLAYER_ACCEPTS_MIGRATION_20"
                    clear dialogue
                    close dialogue
                    wait BW2XT_LAND02_PLAYER_ACCEPTS_MIGRATION_20 + 1 seconds
                end if
            end dialogue
            GB_DialogueIsRunning = 0

            ClosestPosInfluenceRing = marker at get nearest position at PlayerTown influence ring from {AztecTown1}
            run script ge_MoveToRadiusAltitude(godHandle,marker at {ClosestPosInfluenceRing},geGodThrowRadius / 2,geGodThrowAltitude)
            
            wait until GB_DialogueIsRunning == 0
            while miracleCounter < 3
                myRand = number from 1 to 3
                if myRand == 1
                    run script ge_ThrowMiracle(godHandle, GE_MIRACLE_TYPE_STORM, marker at {rGodInstance[godHandle]} + {number from -40 to -25,number from 10 to 30,number from -10 to -15}, 1)
                elsif myRand == 2
                    run script ge_ThrowMiracle(godHandle, GE_MIRACLE_TYPE_FIRE, marker at {rGodInstance[godHandle]} + {number from -40 to -25,number from 10 to 30,number from -10 to -15}, 1)
                else
                    run script ge_ThrowMiracle(godHandle, GE_MIRACLE_TYPE_METEOR, marker at {rGodInstance[godHandle]} + {number from -40 to -25,number from 10 to 30,number from -10 to -15}, 1)
                end if
                wait number from 2 to 7 seconds
                miracleCounter++
            end while
            miracleCounter = 0

            ThrowMiracleTimer = create timer for number from 180 * EpicModifier to 300 * EpicModifier seconds
            ge_Busy[godHandle] = 0
        end if

        if ge_Busy[godHandle] == 0 and get ThunderstormTimer time remaining <= 0 and get player ge_Player[godHandle] mana > 30000 and GB_DialogueIsRunning == 0 and PLAYER of PlayerTown == 0 and ge_EmergencyMode[godHandle] == 0 and ge_Altar[godHandle] == 1
            ge_Busy[godHandle] = 1
            MiracleThunderstormStarted = 1
            myRand = number from 1 to 5
            if myRand == 1 or myRand == 2
                myBuilding = get building ALTAR in PlayerTown min built 0.75

            elsif myRand == 3
                myBuilding = get building STORAGE_YARD in PlayerTown min built 0.75

            elsif myRand == 4
                myBuilding = get building TEMPLE in PlayerTown min built 0.75

            elsif myRand == 5
                myBuilding = get random abode in town PlayerTown
            end if

            if myBuilding exists
                GB_DialogueIsRunning = 1
                begin dialogue
                    myRand = number from 1 to 3
                    if myRand == 1
                        say "BW2XT_LAND02_TALUS_MAKES_LAND_DARK_01"
                        clear dialogue
                        close dialogue
                        wait BW2XT_LAND02_TALUS_MAKES_LAND_DARK_01 + 1 seconds
                    elsif myRand == 2
                        say "BW2XT_LAND02_TALUS_MAKES_LAND_DARK_03"
                        clear dialogue
                        close dialogue
                        wait BW2XT_LAND02_TALUS_MAKES_LAND_DARK_03 + 1 seconds
                    elsif myRand == 3
                        say "BW2XT_LAND02_TALUS_MAKES_LAND_DARK_04"
                        clear dialogue
                        close dialogue
                        wait BW2XT_LAND02_TALUS_MAKES_LAND_DARK_04 + 1 seconds
                    end if
                    if ThunderStormUsed == 0
                        ThunderStormUsed = 1
                        make evil spirit appear
                        say "BW2XT_HELP_TEXT_GUIDANCE_NEED_SHIELD_MIRACLE_10"
                        clear dialogue
                        close dialogue
                        wait BW2XT_HELP_TEXT_GUIDANCE_NEED_SHIELD_MIRACLE_10 + 1 seconds
                        send evil spirit home
                    end if
                end dialogue
                GB_DialogueIsRunning = 0
                run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_THUNDERSTORM,myBuilding,0)
                ThunderstormTimer = create timer for number from 1200 * EpicModifier to 1800 * EpicModifier seconds
            end if
            ge_Busy[godHandle] = 0
        end if

        if townCounter >= 15 or PLAYER of ge_HomeTown[godHandle] != ge_Player[godHandle]
            townCounter = 0
            geChangeTown[godHandle] = 1
        end if

        if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 0
            discipleCounter++ resourcesCounter++ waterForestCounter++ townCounter++ myCounter = 0
        end if

    end while
end script tal_TalusLoop


//Set Emergency mode in this script
begin script tal_TalusEmergency(GodHandle,rTown,PlayerID)

    godHandle = GodHandle
    currentMana = 0
    myCounter = 0
    myInfluence = 0
    EnemyCreature = 0
    EnemyCreatureDist = 0
    EnemyPlatoon = 0
    EnemyCatapult = 0
    Target = 0
    TargetType = 0

start

    while 1 == 1
        wait until rGodInstance[godHandle] exists and tal_EmergencyAllowed == 1
        if myCounter > 2
            myCounter = 0
        end if

        if PlayerID != myCounter
            EnemyCreature = get player myCounter creature
            EnemyCreatureDist = get distance from {ge_HomeTown[godHandle]} to {EnemyCreature}
            EnemyPlatoon = get platoon of player myCounter nearest {ge_HomeTown[godHandle]} radius tal_DefendRadius
            EnemyCatapult = get siege weapon of player myCounter nearest {ge_HomeTown[godHandle]} radius tal_DefendRadius
            Target = 0

            if EnemyPlatoon exists
                myInfluence = get player ge_Player[godHandle] influence at {EnemyPlatoon}
                if myInfluence > 0
                    Target = EnemyPlatoon
                end if
                TargetType = 1
            elsif EnemyCatapult exists and HEALTH of EnemyCatapult > 0
                myInfluence = get player ge_Player[godHandle] influence at {EnemyCatapult}
                if myInfluence > 0
                    Target = EnemyCatapult
                end if
                TargetType = 2
            elsif EnemyCreatureDist < tal_DefendRadius and HEALTH of EnemyCreature > 0
                myInfluence = get player ge_Player[godHandle] influence at {EnemyCreature}
                if myInfluence > 0
                    Target = EnemyCreature
                end if
                TargetType = 3
            end if
            currentMana = get player ge_Player[godHandle] mana
            if Target != 0 and currentMana > geManaCostFire and ge_Altar[godHandle] == 1
                ////say "Set Emergency Mode"
                ge_EmergencyMode[godHandle] = 1
                wait until ge_Busy[godHandle] == 0
                ////say "Fighting Platoon"
                ge_Busy[godHandle] = 1
                run script tal_FightEnemy(godHandle,ge_HomeTown[godHandle],Target,TargetType)
                ge_Busy[godHandle] = 0
                
            elsif Target == 0 or currentMana < geManaCostFire or ge_Altar[godHandle] == 0
                ge_EmergencyMode[godHandle] = 0
            end if
            if get ge_MiracleDelay[godHandle] time remaining > 5
                // Prevent from idling
                if ge_Busy[godHandle] == 0 and ge_EmergencyMode[godHandle] == 1
                    ge_Busy[godHandle] = 1
                    run script tal_MoveRandom(godHandle,ge_HomeTown[godHandle])
                    ge_Busy[godHandle] = 0
                end if
            end if
        end if

        myCounter++
    end while

end script tal_TalusEmergency


begin script tal_SatisfyWoodDesire(GodHandle,rTown)
    godHandle = GodHandle
    myStorehouse = 0
    myTree = 0
    townDesire = 0
    myInfluence = 0
    counter = 0
start
    while counter < 3 and rGodInstance[godHandle] exists
        ////say "Satisfy Wood"
        myStorehouse = get building ABODE_NUMBER_STORAGE_PIT in ge_HomeTown[godHandle] min built 1.0
        myTree = get SCRIPT_OBJECT_TYPE_TREE at {ge_HomeTown[godHandle]} radius tal_ResourceGatherRadius
        myInfluence = get player ge_Player[godHandle] influence at {myTree}
        if myStorehouse exists and myTree exists and myInfluence > 0
            run script ge_PickupResource(godHandle,myTree,GE_HT_WOOD,-1)
            run script ge_DropInStorehouse(godHandle,myStorehouse,-1)
        end if
        counter++
    end while
end script tal_SatisfyWoodDesire

begin script tal_SatisfyOreDesire(GodHandle,rTown)
    godHandle = GodHandle
    myStorehouse = 0
    myOreRock = 0
    townDesire = 0
    myInfluence = 0
    counter = 0
start
    while counter < 3 and rGodInstance[godHandle] exists
        ////say "Satisfy Ore"
        myStorehouse = get building ABODE_NUMBER_STORAGE_PIT in ge_HomeTown[godHandle] min built 1.0
        myOreRock = get SCRIPT_OBJECT_TYPE_ORE_ROCK at {ge_HomeTown[godHandle]} radius tal_ResourceGatherRadius
        myInfluence = get player ge_Player[godHandle] influence at {myOreRock}
        if myStorehouse exists and myOreRock exists and myInfluence > 0
            run script ge_PickupResource(godHandle,myOreRock,GE_HT_ORE,-1)
            run script ge_DropInStorehouse(godHandle,myStorehouse,-1)
        end if
        counter++
    end while
end script tal_SatisfyOreDesire

// Currently only gathers from 1 field //Should gather from multiple fields now
begin script tal_SatisfyFoodDesire(GodHandle,rTown)
    godHandle = GodHandle
    myAltar = 0
    myStorehouse = 0
    myField = 0//get building ABODE_NUMBER_FIELD in rTown min built 1.0
    myHouse = 0
    foodInField = 0
    townDesire = 0
    currentMana = 0
    waterThrows = 0
    counter = 0
start
    while counter < 3 and rGodInstance[godHandle] exists
        //say "Satisfy Food"
        myHouse = get random home in town ge_HomeTown[godHandle]
        myField = get ABODE_NUMBER_FIELD at {myHouse} radius tal_ResourceGatherRadius
        myStorehouse = get building ABODE_NUMBER_STORAGE_PIT in ge_HomeTown[godHandle] min built 1.0
        if myStorehouse exists and myField exists
            foodInField = get resource RESOURCE_TYPE_FOOD in myField
            myAltar = get building ABODE_NUMBER_ALTAR in ge_HomeTown[godHandle] min built 1.0
            if foodInField < 600 and myAltar exists// then try to water
                currentMana = get player ge_Player[godHandle] mana        
                waterThrows = currentMana / geManaCostWater
                if waterThrows > 2 // Max times it will water (make global var?)
                    waterThrows = 2
                end if
                while waterThrows > 0
                    run script ge_ThrowMiracle(godHandle, GE_MIRACLE_TYPE_WATER, myField, 0)
                    waterThrows -= 1
                    wait 3 seconds
                end while
            end if
            run script ge_PickupResource(godHandle,myField,GE_HT_FOOD,-1)
            run script ge_DropInStorehouse(godHandle,myStorehouse,-1)
        end if
        counter++
    end while
end script tal_SatisfyFoodDesire

//Priority list for building
begin script tal_BuildNewBuilding(GodHandle,rTown)
    godHandle = GodHandle
    buildingUnderConstruction = 0
    isThereConstruction = GE_FALSE
    currentMana = 0
    myHome = 0
    myTownSize = 0
start
    if rGodInstance[godHandle] exists
        //say "Build Building"
        myTownSize = size of ge_HomeTown[godHandle]
        // Find out if/which unconstructed building exists (isn't there a way to iterate through game consts??)
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_STORAGE_PIT in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_ALTAR in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get WONDER EPIC_WONDER_NUMBER_SIREN at {ge_HomeTown[godHandle]} radius 750
            if BUILT of buildingUnderConstruction == 1.0 or PLAYER of buildingUnderConstruction != ge_Player[godHandle]
                buildingUnderConstruction = 0
            end if
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get WONDER EPIC_WONDER_NUMBER_HURRICANE at {ge_HomeTown[godHandle]} radius 750
            if BUILT of buildingUnderConstruction == 1.0 or PLAYER of buildingUnderConstruction != ge_Player[godHandle]
                buildingUnderConstruction = 0
            end if
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get WONDER EPIC_WONDER_NUMBER_EARTHQUAKE at {ge_HomeTown[godHandle]} radius 750
            if BUILT of buildingUnderConstruction == 1.0 or PLAYER of buildingUnderConstruction != ge_Player[godHandle]
                buildingUnderConstruction = 0
            end if
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get WONDER EPIC_WONDER_NUMBER_VOLCANO at {ge_HomeTown[godHandle]} radius 750
            if BUILT of buildingUnderConstruction == 1.0 or PLAYER of buildingUnderConstruction != ge_Player[godHandle]
                buildingUnderConstruction = 0
            end if
        end if
        if not buildingUnderConstruction exists and myTownSize > capacity of ge_HomeTown[godHandle] * 0.9
            buildingUnderConstruction = get building ABODE_NUMBER_E in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists and myTownSize > capacity of ge_HomeTown[godHandle] * 0.9
            buildingUnderConstruction = get building ABODE_NUMBER_D in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists and myTownSize > capacity of ge_HomeTown[godHandle] * 0.9
            buildingUnderConstruction = get building ABODE_NUMBER_C in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists and myTownSize > capacity of ge_HomeTown[godHandle] * 0.9
            buildingUnderConstruction = get building ABODE_NUMBER_B in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists and myTownSize > capacity of ge_HomeTown[godHandle] * 0.9
            buildingUnderConstruction = get building ABODE_NUMBER_A in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_TEMPLE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_CREATURE_PEN in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_MELEE_ARMOURY in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_RANGED_ARMOURY in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_CRECHE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_SHRINE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_PUB in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_TOWN_CENTRE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_WORKSHOP in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_STUDY in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_UNIVERSITY in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_PRISON in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_SMELTER in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_GRANARY in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_LUMBERMILL in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_MARKET_POT in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_MARKET_STATUE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_MARKET_PLANT in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_AMPITHEATRE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_GRAVEYARD in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_OLD_PERSONS_HOME in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_BATHHOUSE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_WALLTOWER_TECH0 in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_WALLTOWER_TECH1 in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_GATEHOUSE in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_GATEHOUSE_F in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_SKYSCRAPER in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_E in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_D in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_C in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_B in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if
        if not buildingUnderConstruction exists
            buildingUnderConstruction = get building ABODE_NUMBER_A in ge_HomeTown[godHandle] max built tal_MaxBuiltToGodBuild
        end if

        if buildingUnderConstruction exists
            // This will probably never be true, but just in case
            if buildingUnderConstruction on fire
                currentMana = get player ge_Player[godHandle] mana
                while buildingUnderConstruction exists and buildingUnderConstruction on fire and geManaCostWater <= currentMana

                    run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_WATER,buildingUnderConstruction, 0)
                    currentMana -= geManaCostWater
                end while
            end if
            run script ge_GodBuild(godHandle,buildingUnderConstruction,tal_ResourceGatherRadius)
            buildingUnderConstruction = 0
        end if
    end if
end script tal_BuildNewBuilding


begin script tal_Firefight(GodHandle,rTown)
    godHandle = GodHandle
    damagedBuilding = 0
    isThereConstruction = GE_FALSE
    currentMana = 0
start
    if rGodInstance[godHandle] exists
        //say "Firefight"
        damagedBuilding = get random abode of type ABODE_NUMBER_A in town ge_HomeTown[godHandle]
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_B in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_C in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_D in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_E in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_SKYSCRAPER in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_ALTAR in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_STORAGE_PIT in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_CRECHE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_SHRINE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_TEMPLE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_PUB in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_TOWN_CENTRE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_CREATURE_PEN in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_MELEE_ARMOURY in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_RANGED_ARMOURY in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_WORKSHOP in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_STUDY in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_UNIVERSITY in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_PRISON in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_SMELTER in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_GRANARY in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_LUMBERMILL in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_MARKET_POT in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_MARKET_STATUE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_MARKET_PLANT in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_AMPITHEATRE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_GRAVEYARD in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_OLD_PERSONS_HOME in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_BATHHOUSE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_WALLTOWER_TECH0 in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_WALLTOWER_TECH1 in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_GATEHOUSE in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight
            damagedBuilding = get random abode of type ABODE_NUMBER_GATEHOUSE_F in town ge_HomeTown[godHandle]
        end if
        if not HEALTH of damagedBuilding <= tal_DamageToFirefight or not BUILT of damagedBuilding <= tal_DamageToFirefight 
            damagedBuilding = 0
        end if

        if damagedBuilding exists
            if damagedBuilding on fire
                currentMana = get player ge_Player[godHandle] mana
                while damagedBuilding exists and damagedBuilding on fire and geManaCostWater <= currentMana
                    run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_WATER,damagedBuilding, 0)
                    currentMana -= geManaCostWater
                end while
            end if
            run script ge_GodBuild(godHandle,damagedBuilding,tal_ResourceGatherRadius)
            damagedBuilding = 0
        end if
    end if
end script tal_Firefight


begin script tal_Disciples(GodHandle,rTown)
    godHandle = GodHandle
    numberOfDisciples = 0
    thisBuilding = 0
start
    if rGodInstance[godHandle] exists
        tal_MaleBreeders = adult size of ge_HomeTown[godHandle] * 4 / 100 //4 percent of town
        thisBuilding = get building ABODE_NUMBER_ALTAR in ge_HomeTown[godHandle] min built 1.0
        if thisBuilding exists
            tal_Prayers = adult size of ge_HomeTown[godHandle] * 2 / 100 //2 percent of town
        else
            tal_Prayers = 0
        end if
        tal_Miners = adult size of ge_HomeTown[godHandle] * 1 / 100 //1 percent of town
        tal_NumDiscipleOther = adult size of ge_HomeTown[godHandle] * 2 / 100 //2 percent of town
        //say "Disciples"
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_FARMER in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_NumDiscipleOther // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_FARMER)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_NumDiscipleOther // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_FARMER,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while
        
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_FORESTER in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_NumDiscipleOther // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_FORESTER)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_NumDiscipleOther // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_FORESTER,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while 
        
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_BUILDER in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_NumDiscipleOther // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_BUILDER)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_NumDiscipleOther // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_BUILDER,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while 
        
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_BREEDER in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_MaleBreeders // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_BREEDER)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_MaleBreeders // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_BREEDER,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while 
        
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_WORSHIP in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_Prayers // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_WORSHIP)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_Prayers // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_WORSHIP,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while 
        
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_MINER in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_Miners // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_MINER)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_Miners // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_MINER,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while
        
        numberOfDisciples = get number of disciple VILLAGER_DISCIPLE_REFINER in town ge_HomeTown[godHandle]
        while numberOfDisciples < tal_NumDiscipleOther // Need more
            run script ge_CreateDisciple(godHandle,GE_VILLAGER_DISCIPLE_REFINER)
            numberOfDisciples += 1
        end while
        while numberOfDisciples > tal_NumDiscipleOther // Need less
            run script ge_RemoveDisciple(godHandle,GE_VILLAGER_DISCIPLE_REFINER,tal_ResourceGatherRadius)
            numberOfDisciples -= 1
        end while 
    end if
end script tal_Disciples

begin script tal_MoveRandom(GodHandle,rTown)
    godHandle = GodHandle
    myHome = 0
start
    if rGodInstance[godHandle] exists
        //say "Move Random"
        myHome = get random home in town ge_HomeTown[godHandle]
        if myHome exists
            while HEALTH of myHome >= 1.0 and myHome exists
                run script ge_MoveToObject(godHandle,myHome)
                myHome = 0
            end while
        end if
    end if
end script tal_MoveRandom

begin script tal_WaterForest(GodHandle,rTown)
    godHandle = GodHandle
    counter = 0
    myAltar = 0
    currentMana = 0
    myHouse = 0
    myNumber = 0
    myTree = 0
    myInfluence = 0
start
    if rGodInstance[godHandle] exists
        //say "Water Forest"
        counter = 0
        myHouse = get random home in town ge_HomeTown[godHandle]
        myTree = get SCRIPT_OBJECT_TYPE_TREE at {myHouse} radius tal_ResourceGatherRadius
        myInfluence = get player ge_Player[godHandle] influence at {myTree}
        myAltar = get building ABODE_NUMBER_ALTAR in ge_HomeTown[godHandle] min built 1.0

        currentMana = get player ge_Player[godHandle] mana
        while myAltar exists and myInfluence > 0 and myTree exists and currentMana > 20000 and counter < 2
            run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_WATER,myTree, 0)
            wait 3 seconds
            counter++
        end while
    end if

end script tal_WaterForest

begin script tal_FightEnemy(GodHandle,rTown,Target,TargetType)
    //TargetType = 1: Platoon, TargetType = 2: Catapult, TargetType = 3: Creature
    godHandle = GodHandle
    counter = 0
    myAltar = 0
    currentMana = 0
    myNumber = 0
    myTown = 0
    myInfluence1 = 0
    myInfluence2 = 0
    myPlatoon = 0
    myRock = 0
    myCounter = 0
start
    //say "Fight Platoons"
    if rGodInstance[godHandle] exists
        currentMana = get player ge_Player[godHandle] mana
        if Target exists and not Target on fire
            if currentMana >= geManaCostMeteor + 20000 and PLAYER of Target != ge_Player[godHandle] and get ge_MiracleDelay[godHandle] time remaining <= 0 and ge_Altar[godHandle] == 1
                myNumber = number from 1 to 5
                if myNumber == 1
                    run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_METEOR,Target, 0)
                elsif myNumber == 2 or myNumber == 3
                    run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_FIRE,Target, 0)
                else
                    if TargetType == 1
                        run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_STORM,Target, 0)
                    end if
                end if
            
            elsif currentMana >= geManaCostStorm and PLAYER of Target != ge_Player[godHandle] and get ge_MiracleDelay[godHandle] time remaining <= 0 and ge_Altar[godHandle] == 1
                myNumber = number from 1 to 3
                if myNumber == 1
                    if TargetType == 1
                        run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_STORM,Target, 0)
                    end if
                elsif myNumber == 2 or myNumber == 3
                    run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_FIRE,Target, 0)
                end if

            elsif myRock exists and PLAYER of Target != ge_Player[godHandle]
                //run script geThrowObjectAtObject(godHandle, myRock, myPlatoon)

            end if
            if Difficulty == 1
                ge_MiracleDelay[godHandle] = create timer for 120 seconds
            elsif Difficulty == 2
                ge_MiracleDelay[godHandle] = create timer for 90 seconds
            elsif Difficulty == 3
                ge_MiracleDelay[godHandle] = create timer for 60 seconds
            elsif Difficulty == 4
                ge_MiracleDelay[godHandle] = create timer for 45 seconds
            else
                ge_MiracleDelay[godHandle] = create timer for 30 seconds
            end if
        end if
    end if

end script tal_FightEnemy

begin script tal_EpicSpell(GodHandle,rTown,whichSpell,Target)
    godHandle = GodHandle
    myNumber = 0
    myBuilding = 0
    myLocation = 0
    myRand = 0
    playerMana = 0
    EnemySettlement = 0
    PlayerID = 0
start

    if rGodInstance[godHandle] exists
        ge_EpicSpellDelay[godHandle] = create timer for 450 seconds

        playerMana = get player ge_Player[godHandle] mana
        //Randomize Spell here
        if playerMana >= 45000
            myNumber = number from 1 to 8
            if myNumber == 1
                whichSpell = GE_MIRACLE_TYPE_VERDANT

            elsif myNumber == 2 or myNumber == 3
                whichSpell = GE_MIRACLE_TYPE_FIRERAIN

            elsif myNumber == 4
                whichSpell = GE_MIRACLE_TYPE_THUNDERSTORM

            elsif myNumber == 5 or myNumber == 6 or myNumber == 7 or myNumber == 8 or myNumber == 9
                whichSpell = GE_MIRACLE_TYPE_METEORID

            end if
        elsif playerMana >= 40000
            myNumber = number from 1 to 8
            if myNumber == 1
                whichSpell = GE_MIRACLE_TYPE_VERDANT

            elsif myNumber == 2 or myNumber == 3
                whichSpell = GE_MIRACLE_TYPE_FIRERAIN

            elsif myNumber == 4 or myNumber == 5
                whichSpell = GE_MIRACLE_TYPE_THUNDERSTORM

            end if
        elsif playerMana >= 30000
            myNumber = number from 1 to 6
            if myNumber == 1
                whichSpell = GE_MIRACLE_TYPE_VERDANT

            elsif myNumber == 2 or myNumber == 3
                whichSpell = GE_MIRACLE_TYPE_FIRERAIN

            end if
        elsif playerMana >= 15000
            myNumber = number from 1 to 3
            if myNumber == 1
                whichSpell = GE_MIRACLE_TYPE_VERDANT

            end if
        end if

        if whichSpell != 0
            if whichSpell == GE_MIRACLE_TYPE_VERDANT
                myBuilding = get building ABODE_NUMBER_STORAGE_PIT in ge_HomeTown[godHandle] min built 1.0
                myLocation = marker at {myBuilding} + {number from 20 to 35,number from -20 to -35}
                if not {myLocation} under water
                    run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_VERDANT,myLocation, 0)
                end if

            elsif whichSpell == GE_MIRACLE_TYPE_FIRERAIN or whichSpell == GE_MIRACLE_TYPE_THUNDERSTORM or whichSpell == GE_MIRACLE_TYPE_METEORID
                PlayerID = ge_Player[godHandle]
                EnemySettlement = PlayerTown

                myRand = number from 1 to 5
                if myRand == 1
                    myBuilding = get building ALTAR in EnemySettlement min built 0.75
                elsif myRand == 2
                    myBuilding = get building STORAGE_YARD in EnemySettlement min built 0.75

                elsif myRand == 3
                    myBuilding = get building TEMPLE in EnemySettlement min built 0.75

                elsif myRand >= 4
                    myBuilding = get random abode in town EnemySettlement
                end if


                if myBuilding exists
                    if whichSpell == GE_MIRACLE_TYPE_FIRERAIN
                        run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_FIRERAIN,myBuilding, 0)

                    elsif whichSpell == GE_MIRACLE_TYPE_THUNDERSTORM
                        run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_THUNDERSTORM,myBuilding, 0)

                    elsif whichSpell == GE_MIRACLE_TYPE_METEORID
                        run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_METEORID,myBuilding, 0)

                    end if
                end if
            end if
        end if
    end if

end script tal_EpicSpell

begin script tal_HealMyPlatoon(GodHandle,rTown)
    godHandle = GodHandle
    counter = 0
    myAltar = 0
    currentMana = 0
    myNumber = 0
    myTown = 0
    myInfluence = 0
    myPlatoon = 0
    myRock = 0
    myHome = get random abode in town rTown
start
    //say "Heal Platoons"
    if rGodInstance[godHandle] exists
        myTown = get building ABODE_NUMBER_TOWN_CENTRE in ge_HomeTown[godHandle] min built 1.0
        myAltar = get building ABODE_NUMBER_ALTAR in ge_HomeTown[godHandle] min built 1.0
        myPlatoon = get platoon of player ge_Player[godHandle] nearest {myHome} radius 750
        
        if myPlatoon exists
            myInfluence = get player ge_Player[godHandle] influence at {myPlatoon}
        end if

        currentMana = get player ge_Player[godHandle] mana
        if myAltar exists and myInfluence > 0 and myTown exists and myPlatoon exists
            if currentMana >= geManaCostHeal and PLAYER of myPlatoon == ge_Player[godHandle] and HEALTH of myPlatoon < 0.75
                run script ge_ThrowMiracle(godHandle,GE_MIRACLE_TYPE_HEAL,myPlatoon, 0)
            end if
        end if
    end if

end script tal_HealMyPlatoon