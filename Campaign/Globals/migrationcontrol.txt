///////////////////////////////////////////////////////////////////////////////
//       Migration Control Script
//    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//
///////////////////////////////////////////////////////////////////////////////

define script MigrationControlGetTowns
define script MigrationControl(MigrationTown)

run script MigrationControlGetTowns


begin script MigrationControlGetTowns

AITownScript[20]
scriptCounter = 0

start

    begin loop
        AITownScript[scriptCounter] = get town with id scriptCounter
        run background script MigrationControl(AITownScript[scriptCounter])

        scriptCounter++
        until scriptCounter >= 19
    end loop

end script MigrationControlGetTowns


begin script MigrationControl(MigrationTown)

    myArmySize = 0
    myMigration = 0
    myPlatoon = 0
    myVillager = 0
    myMigrationTarget = 0

start

begin loop
    if variable get town MigrationTown status == variable TOWN_STATUS_MIGRATION_STARTED
        wait 10 seconds
        while not myMigration exists
            myMigrationTarget = get town MigrationTown is migrating to
            myMigration = get migration from MigrationTown to myMigrationTarget
        end while
        while 0 < myArmySize and myMigration exists
            myPlatoon = get platoon nearest {myMigration} radius 25
            myVillager = get VILLAGER at {myMigration} radius 25
            if myVillager exists and not myPlatoon exists and not {myVillager} viewed
                delete myVillager
                myArmySize--
            end if
        end while
        wait until myMigration not exists
    else
        if get army size in town MigrationTown > 0
            myArmySize = get army size in town MigrationTown
        end if
    end if
end loop

end script MigrationControl